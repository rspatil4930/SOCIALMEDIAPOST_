<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Post Maker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Vadodara:wght@600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Hind Vadodara', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .editor-container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        canvas { border: 1px solid #ddd; border-radius: 8px; width: 100% !important; height: auto !important; }
        .controls { margin-top: 15px; display: flex; flex-direction: column; gap: 12px; }
        label { font-weight: bold; color: #800000; font-size: 14px; }
        input[type="text"], input[type="file"] { padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .download-btn { background: #800000; color: white; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 5px; }
        .download-btn:hover { background: #b30000; }
        .note { font-size: 12px; color: #666; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<div class="editor-container">
    <h3 style="text-align: center; color: #800000; margin-top: 0;">પોસ્ટ એડિટર</h3>
    
    <canvas id="mainCanvas"></canvas>

    <div class="controls">
        <label>૧. તમારો ફોટો પસંદ કરો:</label>
        <input type="file" id="uploadPhoto" accept="image/*">
        
        <label>૨. નામ અને વિગત લખો:</label>
        <input type="text" id="userName" placeholder="તમારું નામ, હોદ્દો, સરનામું">
        
        <button class="download-btn" id="saveImage">ડાઉનલોડ કરો</button>
    </div>
    <p class="note">ફોટો પસંદ કર્યા પછી તમે તેને આંગળીથી ગોળ ફ્રેમમાં સેટ કરી શકો છો.</p>
</div>

<script>
    // Canvas dimensions matching your template
    const canvas = new fabric.Canvas('mainCanvas', {
        width: 800,
        height: 1000,
        preserveObjectStacking: true
    });

    let userPhoto = null;

    // 1. Load the Template Background (q.jpg)
    fabric.Image.fromURL('q.jpg', function(img) {
        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
            scaleX: canvas.width / img.width,
            scaleY: canvas.height / img.height
        });
    });

    // 2. Add the Text Layer
    const textLayer = new fabric.Text("તમારું નામ, હોદ્દો, સરનામું", {
        left: 400, 
        top: 895,
        fontSize: 34,
        fill: '#ffffff',
        fontFamily: 'Hind Vadodara',
        originX: 'center',
        selectable: true
    });
    canvas.add(textLayer);

    document.getElementById('userName').oninput = function() {
        textLayer.set('text', this.value || "તમારું નામ, હોદ્દો, સરનામું");
        canvas.renderAll();
    };

    // 3. Handle Photo Upload with 232.99px circular crop
    document.getElementById('uploadPhoto').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(f) {
            if (userPhoto) canvas.remove(userPhoto);

            fabric.Image.fromURL(f.target.result, function(img) {
                // Set scale so it fills the 232.99px circle area
                img.scaleToWidth(240); 
                
                img.set({
                    left: 860, // Adjusted for the larger circle
                    top: 890, 
                    originX: 'center',
                    originY: 'center',
                    // Radius set to half of 232.99px (116.5px)
                    clipPath: new fabric.Circle({
                        radius: 116.5,
                        originX: 'center',
                        originY: 'center'
                    })
                });

                userPhoto = img;
                canvas.add(img);
                
                // Keep the background in the back and photo behind text
                canvas.sendToBack(img);
                canvas.bringForward(img); 
                
                canvas.setActiveObject(img);
                canvas.renderAll();
            });
        };
        reader.readAsDataURL(file);
    });

    // 4. Download function
    document.getElementById('saveImage').onclick = function() {
        const dataURL = canvas.toDataURL({
            format: 'jpeg',
            quality: 1.0
        });
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = 'community_post.jpg';
        link.click();
    };
</script>

</body>
</html>